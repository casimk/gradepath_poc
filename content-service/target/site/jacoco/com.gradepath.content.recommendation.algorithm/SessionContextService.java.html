<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionContextService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">content-service</a> &gt; <a href="index.source.html" class="el_package">com.gradepath.content.recommendation.algorithm</a> &gt; <span class="el_source">SessionContextService.java</span></div><h1>SessionContextService.java</h1><pre class="source lang-java linenums">package com.gradepath.content.recommendation.algorithm;

import com.gradepath.content.content.model.Content;
import com.gradepath.content.recommendation.profile.BehavioralProfile;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.DayOfWeek;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.Optional;

/**
 * Session context scoring based on time-of-day and user patterns
 * TikTok-style: adapts recommendations based on current session context
 */
@Service
<span class="fc" id="L18">@Slf4j</span>
<span class="fc" id="L19">public class SessionContextService {</span>

    /**
     * Calculate session context score for content
     * Returns 0.0 to 1.0 based on how well content fits current session
     */
    public double calculateSessionScore(Content content, Optional&lt;BehavioralProfile&gt; profile) {
<span class="nc" id="L26">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L27">        int currentHour = now.getHour();</span>
<span class="nc" id="L28">        DayOfWeek currentDay = now.getDayOfWeek();</span>

<span class="nc" id="L30">        double timeScore = calculateTimeScore(currentHour, currentDay, profile);</span>
<span class="nc" id="L31">        double energyScore = calculateEnergyScore(currentHour, content.getEstimatedDurationMinutes());</span>
<span class="nc" id="L32">        double patternScore = calculatePatternScore(currentHour, currentDay, profile);</span>

        // Weighted combination
<span class="nc" id="L35">        return (timeScore * 0.4) + (energyScore * 0.3) + (patternScore * 0.3);</span>
    }

    /**
     * Time-of-day scoring - matches content to optimal viewing times
     */
    private double calculateTimeScore(int hour, DayOfWeek day, Optional&lt;BehavioralProfile&gt; profile) {
        // Default time preferences if no profile
<span class="nc bnc" id="L43" title="All 2 branches missed.">        if (profile.isEmpty()) {</span>
<span class="nc" id="L44">            return getDefaultTimeScore(hour);</span>
        }

<span class="nc" id="L47">        BehavioralProfile p = profile.get();</span>
<span class="nc" id="L48">        return p.getPeakWindows().stream()</span>
<span class="nc bnc" id="L49" title="All 4 branches missed.">            .filter(w -&gt; w.getDay().equalsIgnoreCase(day.name()) || w.getDay().equals(&quot;all&quot;))</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">            .filter(w -&gt; Math.abs(w.getHour() - hour) &lt;= 1) // Within 1 hour</span>
<span class="nc" id="L51">            .findFirst()</span>
<span class="nc" id="L52">            .map(PeakWindow -&gt; PeakWindow.getScore())</span>
<span class="nc" id="L53">            .orElse(getDefaultTimeScore(hour));</span>
    }

    /**
     * Default time score when no behavioral profile exists
     * Morning (6-12): 0.7, Afternoon (12-18): 0.9, Evening (18-22): 1.0, Night (22-6): 0.5
     */
    private double getDefaultTimeScore(int hour) {
<span class="nc bnc" id="L61" title="All 4 branches missed.">        if (hour &gt;= 6 &amp;&amp; hour &lt; 12) return 0.7;</span>
<span class="nc bnc" id="L62" title="All 4 branches missed.">        if (hour &gt;= 12 &amp;&amp; hour &lt; 18) return 0.9;</span>
<span class="nc bnc" id="L63" title="All 4 branches missed.">        if (hour &gt;= 18 &amp;&amp; hour &lt; 22) return 1.0;</span>
<span class="nc" id="L64">        return 0.5;</span>
    }

    /**
     * Energy scoring - shorter content when energy is low (late night)
     * Longer content when energy is high (morning/afternoon)
     */
    private double calculateEnergyScore(int hour, Integer contentDurationMinutes) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (contentDurationMinutes == null) return 0.8;</span>

        // Energy level based on time of day
<span class="nc" id="L75">        double energyLevel = getEnergyLevel(hour);</span>

        // Match content length to energy
        // Short content (&lt;= 5 min) is good for low energy
        // Long content (&gt; 20 min) is good for high energy
<span class="nc" id="L80">        double optimalDurationMinutes = energyLevel * 30; // 0-30 minutes based on energy</span>

<span class="nc" id="L82">        double durationDifference = Math.abs(contentDurationMinutes - optimalDurationMinutes);</span>
<span class="nc" id="L83">        return Math.max(0.2, 1.0 - (durationDifference / 30.0));</span>
    }

    /**
     * Get user energy level (0.0 to 1.0) based on time of day
     */
    private double getEnergyLevel(int hour) {
<span class="nc bnc" id="L90" title="All 4 branches missed.">        if (hour &gt;= 6 &amp;&amp; hour &lt; 12) return 0.9; // Morning - high energy</span>
<span class="nc bnc" id="L91" title="All 4 branches missed.">        if (hour &gt;= 12 &amp;&amp; hour &lt; 18) return 0.8; // Afternoon - good energy</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">        if (hour &gt;= 18 &amp;&amp; hour &lt; 22) return 0.6; // Evening - moderate energy</span>
<span class="nc" id="L93">        return 0.3; // Night - low energy</span>
    }

    /**
     * Pattern scoring - matches user's historical session patterns
     */
    private double calculatePatternScore(int hour, DayOfWeek day, Optional&lt;BehavioralProfile&gt; profile) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (profile.isEmpty()) return 0.5;</span>

<span class="nc" id="L102">        BehavioralProfile p = profile.get();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (p.getEngagement() == null) return 0.5;</span>

        // Check if user typically engages at this time
<span class="nc" id="L106">        boolean isPeakTime = p.getPeakWindows().stream()</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">            .anyMatch(w -&gt; w.getDay().equalsIgnoreCase(day.name()) &amp;&amp; Math.abs(w.getHour() - hour) &lt;= 1);</span>

        // Bonus if this is the user's peak time
<span class="nc bnc" id="L110" title="All 2 branches missed.">        return isPeakTime ? 1.0 : 0.6;</span>
    }

    /**
     * Get session context reason for explanation
     */
    public String getSessionReason(double score, LocalDateTime now) {
<span class="nc" id="L117">        int hour = now.getHour();</span>
<span class="nc bnc" id="L118" title="All 4 branches missed.">        if (hour &gt;= 6 &amp;&amp; hour &lt; 12) return &quot;Good for morning learning&quot;;</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">        if (hour &gt;= 12 &amp;&amp; hour &lt; 18) return &quot;Great for afternoon sessions&quot;;</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">        if (hour &gt;= 18 &amp;&amp; hour &lt; 22) return &quot;Perfect for evening learning&quot;;</span>
<span class="nc" id="L121">        return &quot;Quick content for late night&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>