<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShortsStrategyService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">content-service</a> &gt; <a href="index.source.html" class="el_package">com.gradepath.content.recommendation.algorithm</a> &gt; <span class="el_source">ShortsStrategyService.java</span></div><h1>ShortsStrategyService.java</h1><pre class="source lang-java linenums">package com.gradepath.content.recommendation.algorithm;

import com.gradepath.content.content.model.Content;
import com.gradepath.content.recommendation.profile.BehavioralProfile;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

/**
 * Shorts-aware recommendation strategy
 * Handles short-form content (30-60s) differently from long-form
 */
@Service
<span class="fc" id="L16">@Slf4j</span>
<span class="fc" id="L17">public class ShortsStrategyService {</span>

    private static final int SHORTS_THRESHOLD_SECONDS = 90; // 1.5 minutes
    private static final int SHORTS_MIN_SECONDS = 20;

    /**
     * Determine content type strategy based on user behavior
     */
    public ContentStrategy determineStrategy(Optional&lt;BehavioralProfile&gt; profile, List&lt;Content&gt; recentContent) {
<span class="nc bnc" id="L26" title="All 2 branches missed.">        if (profile.isEmpty()) {</span>
<span class="nc" id="L27">            return ContentStrategy.BALANCED;</span>
        }

<span class="nc" id="L30">        BehavioralProfile p = profile.get();</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">        if (p.getEngagement() == null) {</span>
<span class="nc" id="L32">            return ContentStrategy.BALANCED;</span>
        }

        // Detect if user is in &quot;snack mode&quot; (consuming shorts)
<span class="nc" id="L36">        boolean inShortsMode = isInShortsMode(recentContent);</span>
<span class="nc" id="L37">        String classification = p.getEngagement().getClassification();</span>

        // Strategy selection
<span class="nc bnc" id="L40" title="All 4 branches missed.">        if (inShortsMode &amp;&amp; classification.equals(&quot;explorer&quot;)) {</span>
<span class="nc" id="L41">            return ContentStrategy.DISCOVERY_SHORTS; // Mixed topics, new discoveries</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">        } else if (inShortsMode) {</span>
<span class="nc" id="L43">            return ContentStrategy.SHORTS_ONLY; // Short content for quick consumption</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        } else if (classification.equals(&quot;deep_learner&quot;)) {</span>
<span class="nc" id="L45">            return ContentStrategy.DEEP_DIVE; // Long-form, same topic</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        } else if (classification.equals(&quot;specialist&quot;)) {</span>
<span class="nc" id="L47">            return ContentStrategy.TOPIC_FOCUSED; // Narrow topic focus</span>
        } else {
<span class="nc" id="L49">            return ContentStrategy.BALANCED;</span>
        }
    }

    /**
     * Check if user is in &quot;shorts mode&quot; (consuming short content)
     */
    private boolean isInShortsMode(List&lt;Content&gt; recentContent) {
<span class="nc bnc" id="L57" title="All 4 branches missed.">        if (recentContent == null || recentContent.isEmpty()) {</span>
<span class="nc" id="L58">            return false;</span>
        }

        // Check if last 3 items were all shorts
<span class="nc" id="L62">        long shortsCount = recentContent.stream()</span>
<span class="nc" id="L63">            .limit(3)</span>
<span class="nc" id="L64">            .filter(this::isShort)</span>
<span class="nc" id="L65">            .count();</span>

<span class="nc bnc" id="L67" title="All 2 branches missed.">        return shortsCount &gt;= 2;</span>
    }

    /**
     * Check if content is a short
     */
    public boolean isShort(Content content) {
<span class="nc" id="L74">        Integer durationMinutes = content.getEstimatedDurationMinutes();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (durationMinutes != null) {</span>
<span class="nc" id="L76">            int durationSeconds = durationMinutes * 60;</span>
<span class="nc bnc" id="L77" title="All 4 branches missed.">            return durationSeconds &gt;= SHORTS_MIN_SECONDS &amp;&amp; durationSeconds &lt;= SHORTS_THRESHOLD_SECONDS;</span>
        }

        // QUIZ and EXERCISE are typically short content types
<span class="nc bnc" id="L81" title="All 2 branches missed.">        return content.getType() == Content.ContentType.QUIZ ||</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">               content.getType() == Content.ContentType.EXERCISE;</span>
    }

    /**
     * Filter content based on strategy
     */
    public List&lt;Content&gt; filterByStrategy(List&lt;Content&gt; candidates, ContentStrategy strategy) {
<span class="nc" id="L89">        return candidates.stream()</span>
<span class="nc" id="L90">            .filter(content -&gt; matchesStrategy(content, strategy))</span>
<span class="nc" id="L91">            .toList();</span>
    }

    /**
     * Check if content matches the strategy
     */
    private boolean matchesStrategy(Content content, ContentStrategy strategy) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        return switch (strategy) {</span>
<span class="nc" id="L99">            case SHORTS_ONLY, DISCOVERY_SHORTS -&gt; isShort(content);</span>
<span class="nc" id="L100">            case DEEP_DIVE, TOPIC_FOCUSED, BALANCED -&gt; true; // All content types allowed</span>
        };
    }

    /**
     * Calculate strategy-specific score boost
     */
    public double calculateStrategyBoost(Content content, ContentStrategy strategy) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (matchesStrategy(content, strategy)) {</span>
<span class="nc bnc" id="L109" title="All 5 branches missed.">            return switch (strategy) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                case SHORTS_ONLY -&gt; isShort(content) ? 0.3 : 0.0;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                case DISCOVERY_SHORTS -&gt; isShort(content) ? 0.4 : 0.1;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                case DEEP_DIVE -&gt; !isShort(content) ? 0.3 : 0.0;</span>
<span class="nc" id="L113">                case TOPIC_FOCUSED -&gt; 0.2;</span>
<span class="nc" id="L114">                case BALANCED -&gt; 0.1;</span>
            };
        }
<span class="nc" id="L117">        return 0.0;</span>
    }

    /**
     * Get strategy explanation
     */
    public String getStrategyReason(ContentStrategy strategy) {
<span class="nc bnc" id="L124" title="All 5 branches missed.">        return switch (strategy) {</span>
<span class="nc" id="L125">            case SHORTS_ONLY -&gt; &quot;Quick content perfect for your current session&quot;;</span>
<span class="nc" id="L126">            case DISCOVERY_SHORTS -&gt; &quot;Exploring new topics with short content&quot;;</span>
<span class="nc" id="L127">            case DEEP_DIVE -&gt; &quot;Deep dive into topics you care about&quot;;</span>
<span class="nc" id="L128">            case TOPIC_FOCUSED -&gt; &quot;Focused content matching your interests&quot;;</span>
<span class="nc" id="L129">            case BALANCED -&gt; &quot;Personalized mix for you&quot;;</span>
        };
    }

<span class="nc" id="L133">    public enum ContentStrategy {</span>
<span class="nc" id="L134">        SHORTS_ONLY,           // Only short content (snack mode)</span>
<span class="nc" id="L135">        DISCOVERY_SHORTS,      // Shorts for exploration (new topics)</span>
<span class="nc" id="L136">        DEEP_DIVE,             // Long-form, single topic</span>
<span class="nc" id="L137">        TOPIC_FOCUSED,         // Narrow topic focus</span>
<span class="nc" id="L138">        BALANCED               // Mix of all types</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>